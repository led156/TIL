# 2.1. 크로스 집계의 기본
## 트랜잭션 테이블, 크로스 테이블, 피벗 테이블
- 크로스 테이블(cross table) : 행과 열이 교차하는 부분에 숫자 데이터가 들어가는 테이블
  + | |2017년 1월|2017년 2월|2017년 3월|
    |-|--|--|--|
    |상품A|100|200|300|
    |상품B|10|4|50|
  + 데이터베이스에 행을 추가하는 것은 간단하지만, 열을 늘리는 것은 간단하지 않음. -> 데이터베이스에서는 다루기 어려운 데이터 형식.
- 트랜잭션 테이블(transaction table) : 행 방향으로 증가하는 테이블
  + |매출 월|상품명|금액|
    |-|--|--|
    |2017년 1월|상품A|100|200|
    |2017년 1월|상품B|10|4|
  + 데이터가 행 방향으로만 증가하게 하고, 열 방향으로는 데이터를 증가시키지 않도록 해야 함.
- 크로스 집계(cross tabulation) : 트랜잭션 테이블 → 크로스 테이블로 변환하는 과정
  + 피벗 테이블(pivot table) : 소량의 데이터를 크로스 집계하는데 편리한 것.
 
## 룩업 테이블
- 룩업 테이블(lookup table) : 트랜잭션 테이블을 다른 테이블과 결한하고 싶은 경우 사용되는 것.

## 테이블의 종횡 변환
### SQL
- 피벗 : group by
- 언피벗 : union all, cross join unnest
### Pandas
- 피벗 : pivot
- 언피벗 : melt

## 데이터 집계 → 데이터 마트 → 시각화
- 데이터 집계, 시각화 사이에 있는 것이 데이터 마트
- 데이터 마트가 작으면, 시각화하는 것이 간단 -> 포함된 정보를 잃어버릴 수도.
- 데이터 마트가 크면, 원래 데이터에 포함된 정보를 거대하게 남길 -> 좋은 시각화를 못하게 될 수도.

# 2.2. 열 지향 스토리지에 의한 고속화
## 데이터베이스의 지연을 줄이기
- 데이터양이 증가함에 따라 집계에 걸리는 시간은 길어짐.
  <img width="441" alt="image" src="https://github.com/led156/TIL/assets/67251510/a5d039e2-69e1-42f1-8c52-63ee84895a23">
- 데이터 수집 단계에서 이를 예측할 수 없으므로, 3계층의 구조로 사용.
  
### 데이터 처리의 지연
- 몇 GB정도의 데이터양이라면 MySQL, PostgreSQL 등 일반적인 RDB가 데이터 마트에 적합. (대기 시간이 적다)
  + RDB는 원래 지연이 적고, 많은 수의 클라이언트가 동시 접속해도 성능이 나빠지지 않으므로 우수.
  + 다만 RDB는 메모리가 부족하면 급격히 성능이 저하됨. 많은 양의 I/O가 발생하는 데이터 집계에서는 이를 어떻게 효율화할것인지가 중요한 열쇠가 됨.


### ①'압축'과 '분산'에 의해 지연 줄이기 : MPP 기술
- 데이터를 가능한 작게 압축하고 그것을 여러디스크에 분산함으로써 데이터 로드에 따른 지연을 줄인다.
- MPP(massive parallel processing) : 멀티코어를 활용하면서 디스크 I/O를 병렬 처리하는 것이 효과적임.
  + 분산된 데이터를 읽어들이기 적합함.
  + Amazon Redshift, Google BigQuery 등
- MPP는 데이터 집계에 최적화되어 있으며, 데이터 웨어하우스와 데이터 분석용의 데이터베이스에서 특히 많이 사용됨.

## 열 지향 데이터베이스 접근
- 행 지향 데이터베이스(row-oriented database) : 레코드 단위의 읽고 쓰기에 최적화되어 있는 데이터베이스.
  <img width="436" alt="image" src="https://github.com/led156/TIL/assets/67251510/22e46bc5-4043-4624-9ae7-68335c2b614f">

  + 각 행을 하나의 덩어리로 디스크에 저장.
  + 그러면 새 레코드를 추가할 때 파일의 끝에 데이터를 쓸 뿐이므로 빠르게 추가할 수 있음.
  + 매일 발생하는 대량의 트랜잭션을 지연 없이 처리하기 위해 데이터 추가를 효율적으로 할 수 있도록 하는 것
  + Oracle, MySQL
  + 데이터 검색을 고속화하기 위해 '인덱스'를 만든다.
  + 만약 인덱스가 없다면, 저장되는 모든 데이터를 로드해야 원하는 레코드를 찾을 수 있으므로, 적절한 인덱스가 사용되도록 튜닝하는 것이 중요함.
  + 다만, 데이터 분석에서 어떤 칼럼이 사용되는지 미리 알 수 없기 때문에, 인덱스를 작성해도 도움이 되지 않는다. 따라서 인덱스에 의지하지 않는 고속화 기술이 필요함.

  
- 열 지향 데이터베이스(column-oriented database) :
  <img width="389" alt="image" src="https://github.com/led156/TIL/assets/67251510/c827c920-b17b-4b6a-a9af-bd591fd7239d">

  + 칼럼 단위의 집계에 최적화.
  + 데이터 압축 효율도 우수함 : 같은 문자열의 반복은 매우작게 압축할 수 있음. (행 지향과 비교하여 1/10 이하)
  + Teradata
 
### 처리량과 지연 시간
- 처리량(throughput) : 일정 시간에 처리할 수 있는 데이터의 양
- 지연 : 데이터 처리가 끝날 때까지의 대기 시간
<img width="352" alt="image" src="https://github.com/led156/TIL/assets/67251510/baa8352d-e5b2-42aa-ba2c-509d296464c0">


## ②MPP 데이터베이스의 접근 방식 : 병렬화
- 행 지향 데이터베이스에서는 하나의 쿼리는 하나의 스레드에서 실행된다. 각 쿼리가 충분히 짧은 시간에 끝나는 것으로 생각하기 때문.
- 열 지향 데이터베이스에서는 대량의 데이터를 읽기 때문에, 쿼리 실행이 길어진다. 또한 압축된 데이터의 전개 등으로 CPU 리소스를 필요로 하므로 멀티 코어를 활용하여 고속화하는 것이 좋다.
- MPP에서는 하나의 쿼리를 다수의 작은 태스크로 분해하고 이를 가능한 한 병렬로 실행한다.
<img width="471" alt="image" src="https://github.com/led156/TIL/assets/67251510/82807a2e-0a83-4ea7-918a-db2a6f682b67">

### MPP 데이터베이스와 대화형 쿼리 엔진
- 쿼리를 잘 병렬화할 수 있다면, MPP를 사용한 데이터의 집계는 CPU 코어 수에 비례하여 고속화됨.
  + 단, 디스크로부터 로드가 병목 현상이 발생하지 않도록 데이터가 고르게 분산되어 있어야 함.
- MPP는 구조상, 고속화를 위해 CPU, 디스크 모두를 균형 있게 늘려야 함.
  + 따라서 일부 제품은 HW, SW가 통합된 제품으로 제공됨.
  + 이처럼 하드웨어 수준에서 최적화된 데이터베이스를 ⑴'MPP 데이터베이스'라고 함.
- MPP의 아키텍처는 Hadoop과 함께 사용되는 ⑵대화형 쿼리 엔진으로도 채택되고 있다.
  + 이경우 데이터를 저장하는 것은 분산 스토리지의 역할.
  + 그러나 열 지향으로 데이터를 압축하지 않는 한 MPP 데이터베이스와 동등한 성능은 되지 못함.
  + 따라서, Hadoop 상에서 열 지향 스토리지를 만들기 위해 여러 라이브러리가 개발되고 있다.
- 두 방법 어느 쪽을 선택하더라고, 열 지향의 스토리지 형식으로 저장해야 하는 것은 같음.
|집계 시스템 종류|스토리지의 종류|최적의 레코드 수|
|--|--|--|
|RDB|행 지향|~수천만 정도|
|⑴MPP 데이터베이스|열 지향(하드웨어 일체형)|수억~|
|⑵대화형 쿼리 엔진|열 지향(분산 스토리지에 보관)|수억~|

# 2.3. 애드 혹 분석과 시각화 도구
## Jupyter Notebook에 의한 애드 혹 분석

## 대시보드 도구 : 정기적으로 집계 결과를 시각화하기
- 정해진 지표의 일상적인 변화를 모니터링하고 싶은 경우 적합.
- `Redash` : SQL에 의한 쿼리의 실행 결과를 그대로 시각화
  + ... p.72
- `Superset` : 화면상에서 마우스 조작만으로 그래프를 만들기
- 실시간 시각화 `Kibana` : Elasticsearch의 프런트 엔드에서 실시간으로 작성
  
## BI 도구 : 대화적인 대시보드
- `Tableau Desktop`


# 2.4. 데이터 마트의 기본 구조 🫥
- BI 도구에서 대화형으로 데이터를 참고하기 위해, 시각화에 필요한 정보만을 모은 데이터마트가 필수적임.
## 시각화에 적합한 데이터 마트 만들기 - OLAP
- OLAP(online analytical processing)


