<img width="478" alt="image" src="https://github.com/led156/TIL/assets/67251510/6c1a0e09-f242-4c3d-8cb3-13118d727b1a">

# 5.1. 워크플로 관리
## [기초 지식] 워크플로 관리
- 워크플로 관리(workflow management) : 정형적인 업무 프로세스를 원활하게 진행하기 위한 구조
  + 해당 구조는 배치 처리 실행에도 유용하여 데이터 처리 현장에서도 자주 이용됨.

### 워크플로 관리 도구
- 워크플로 관리 도구의 주요 역할
  + 정기적으로 태스크를 실행하기
  + 비정상적인 상태를 감지하여 그것에 대한 해결을 돕기

|이름|종류|개발사|
|---|---|---|
|Aiflow(에어플로우)|스크립트 형|Airbnb|
|Azkaban(아즈카반)|선언형|LinkedIn|
|Digdag(디그더그)|선언형|트레주어 데이터|
|Luigi(루이지)|스크립트 형|Spotify|
|Oozie(우지)|선언 형|Apache|

### 워크플로 관리 도구와 태스크
- 태스크(Task) : 실행되는 개별처리
- 데이터 파이프라인의 실행 과정에선 데이터를 잇달아 이동하면서 정해진 태스크를 반복함.
<img width="595" alt="image" src="https://github.com/led156/TIL/assets/67251510/115f3e48-c59c-4beb-a923-3f708249b3b0">

### 기본 기능과 빅데이터에서 요구되는 기능
- 워크플로 전용 도구를 사용하는 이유는 태스크 실행에 실패했을 때를 대비해서이다.
  + 데이터 파이프라인이 복잡해지거나, 태스크 수가 증가하면 실패한 태스크를 다시 실행하는 것조차 어려워짐.
- 워크플로 관리 도구의 주요 기능
  + 태스크를 정기적인 스케줄로 실행하고 그 결과 통지하기
  + 태스크 간의 의존 관계를 정하고, 정해진 순서대로 빠짐없이 실행하기
  + 태스크의 실행 결과를 보관하고, 오류 발생 시에는 재실행할 수 있도록 하기
- 이런 기본 기능과, Hadoop에서의 잡(Job)을 손쉽게 호출하거나 집계 결과를 데이터 마트에 기록하는 기능을 제공하는 등 데이터 파이프라인의 모든 태스크를 일원 관리하기 쉽게 한 것.


### 선언 형과 스크립트 형
- 선언형(declarative) 도구
  + XML/YAML 등의 서식으로 워크플로를 기술하는 타입
  + 미리 제공된 기능만 이용할 수 있음
    * 범위 안이라면 최소한의 기술로 태스크를 정의할 수 있음.
    * 누가 작성해도 동일한 워크플로가 되기 때문에 유지 보수성이 높음.
  + 동일 쿼리를 파라미터만 바꾸어 실행하거나, 단순 반복적으로 자동 생성하는 경우에도 이용됨.
- 스크립트 형(scripting) 도구
  + 스크립트 언어로 워크플로를 정의하는 타입
  + 태스크의 정의를 프로그래밍 가능 (유연성 높음)
    * 변수, 제어 구문이 사용 가능하기 때문
  + 데이터 처리를 태스크 안에서 실행하는 것도 가능
  + 예시) 파일의 문자 코드를 변환하면서 서버에 업로드하는 식의 태스크
- 각 태스크에서 나누어 사용하는 것도 하나의 방법이다.
  + ETL 프로세스 = 스크립트 형 도구 / SQL의 실행 = 선언형 도구 / ...
  + 데이터 수집 과정에서는 스크립트 처리가 필요한 경우가 많아 스크립트 형의 도구를 사용
  + 데이터를 모아 두면 정형적인 처리만 하므로, 이후 선언형 도구를 사용
 
## 오류로부터의 복구 방법 먼저 생각하기
- 빅데이터 취급시 발생하는 오류에 대한 대처 방법을 결정해두어야 함.
  + 네트워크의 일시적 장애나 하드웨어 장애
  + 스토리지의 용량 부족
  + 쿼리 증가에 따른 성능 부족
  + 등 ..
 
### 복구와 플로우의 재실행
- 오류
  + 몇 차례 반복하면 성공하는 것 (예시:통신 오류)
  + 몇 차례 반복해도 실패하는 것 (예시:인증 오류)
- 오류에는 수많은 가능성이 있으므로 기본적으로 오류로부터 자동 회복할 수 있다는 점을 고려하지 않고 설계한다.
- 대신 수작업에 의한 '복구(recovery)'를 전제로 태스크를 설계함.
  + 실패한 태스크는 모두 기록하여 나중에 재실행할 수 있도록 함. (플로우, 파라미터를 자동으로 기록함)
- 플로우(flow) : 워크플로 관리 도구에 의해 실행되는 일련의 태스크
  + 각 플로우에는 실행 시에 고정 파라미터가 부여되어 있음 (일별 배치 처리라면, 특정 날짜가 파라미터가 됨)
  + 동일 플로우에 동일 파라미터를 건네면, 완전히 동일한 태스크가 실행됨.
  + → 실패한 플로우를 나중에 동일하게 재실행할 수 있기 때문. → 재실행하여 복구

### 재시도
- 태스크 단위의 자동적인 '재시도(retry)' : 여러 번 발생하는 오류에 대해 되도록 자동화하여 수작업 없이 복구하고 싶을 것임.
- 재시도 횟수
  + 재시도가 적으면 장애 복구 전에 재시도가 종료하게 되어, 태스크 실행에 실패함
  + 재시도가 많으면 태스크가 실패하지도 않은 것처럼 되기 때문에 중대한 문제가 발생해도 눈치채지 못함
  + 이상적 : 전혀 재시도 없이 모든 오류를 통지하는 것이 좋음.
- 예기치 않은 오류에 대해 수작업으로 복구함
  + 문제에 대해 확인하고, 태스크의 재시도로 대처하는 것이 아니라 올바른 문제 해결 방법을 찾도록 함.

### 백필
- 백필(backfill) : 플로우 전체를 처음부터 다시 실행하는 것
  <img width="594" alt="image" src="https://github.com/led156/TIL/assets/67251510/6d83ea4a-49cd-4dff-be6e-d6262a6e2c6f">

  + 파라미터에 포함된 일시를 순서대로 바꿔가면서 일정 기간의 플로우를 연속해서 실행하는 구조
  + 태스크의 실패가 며칠 동안이나 계속된 후에 이를 모두 모아 재실행하고 싶을 때나 / 새롭게 만든 워크플로를 과거로 거슬러 올라가 실행하고 싶은 경우에 사용
 
- 백필에 의해 대량 태스크를 실행할 때 성능상의 주의가 필요함
  + 예시) 새롭게 일별 플로우를 작성했을 때.
    * 백필로 과거 30일 데이터를 처리하려고 하면, 하루의 30배나 되는 데이터를 한 번에 처리하려고 하면 큰 부하가 걸림
    * 따라서 평소라면 일어나지 않을 오류가 대량 발생할 수도...

- 대규모 백필을 실시할 땐 자동적인 재시도는 모두 무효로, 오류는 모두 통지하도록 한다.
  + 조금씩 백필을 실행하여 어떤 오류가 발생하는지 확인하고, 오류가 잦다면 실행 속도를 낮춰 부하를 떨어뜨려야 함.
  + 마지막에 오류가 난 태스크만을 재실행하면 모든 백필이 완료.
 
## 멱등한 조작으로 태스크를 기술하기
- 복구의 전제로써 기억해야 할 것은 재실행의 안전성
  + 태스크 도중 실패했을 때 도중 경과가 남아 있으면, 태스크 재실행에 의해 데이터가 혼재하게 됨
  + 따라서 각 태스크는 원칙적으로 '마지막까지 성공'하거나 '실패하면 아무것도 남지 않음' 둘 중 하나만 존재해야 함.

### 원자성 조작(atomic operation)
- 각 태스크가 시스템에 변경을 가하는 것을 한 번만 할 수 있도록 하는 것 (또는 여러 번의 쓰기를 한 번의 트랜잭션으로 처리)
- 테스크 구현상의 버그 등으로 원자성 조작 직후 문제가 발생하면 이를 보장하지 않을 수도 있다.
  + 예시) 데이터베이스에 데이터를 로드할 때
    * 네트워크 경유의 로드 명령을 발행
    * 직후에 통신이 끊어져 오류가 발생...
    * 이 경우, 로드 명령이 취소될지 아닐지는 데이터베이스를 조작해봐야 앎.
    * 워크플로 관리 도구는 오류 내용에 관여하지 않으므로, 로드 명령이 계속 실행되고 있다면 재시도에서 중복이 발생함.
- 아주 작은 가능성도 허가하지 않을 때는 원자성 조작에 의존한 플로우를 사용해선 안 됨.
  + 적어도 워크플로 관리 도구에 의한 자동적인 재시도는 피하고, 오류의 내용을 반드시 확인한 뒤에 수동으로 복구해야 함.

### 멱등한 조작 : 추가와 치환
- 멱등한 조작(idempotent operation) : 동일한 태스크를 여러 번 실행해도 동일한 결과가 되도록 하는 것
  + 예시) SQL이라면 테이블을 삭제한 후에 다시 만들기가 멱등한 조작의 예임.
  + 만약 도중 오류가 발생해 재실행 해도 다시 한번 테이블을 만드는 부분부터 시작해 중복이 발생X.
- 각 태스크를 어떻게 멱등하게 할 것인지는 이용자의 책임. (원칙은 항상 데이터를 덮어쓰는 것)
  + 추가(append) : 매번 새로운 파일명을 만들 경우
  + 치환(replace) : 동일 파일명으로 덮어쓰는 것
- 추가를 반복하면 데이터가 중복되지만, 치환은 반복해도 결과가 변하지 않음. (따라서 치환은 멱등하다)
  + 즉, 멱등한 태스크를 만들기 위해 태스크에 부여된 파라미터를 잘 이용해 고유의 이름을 생성하고, 여러 번 실행해도 항상 치환이 시행되도록 설계.
  + 그렇지 않으면 멱등한 태스크가 되지 못하므로 자동으로 복구하는 것이 어려운 플로우가 됨.

### 멱등한 추가
- 

# 5.2.



# 5.3.



